---
# ═══════════════════════════════════════════════════════════════════════════════
# WORKFLOW DOCUMENTATION
# ═══════════════════════════════════════════════════════════════════════════════
#
# @name Generate NestJS Service Backstage
# @description Validates inputs for NestJS microservice generation via Backstage.
#
# @triggers workflow_dispatch (manual)
#
# @inputs
#   - project_name (required): Repository name in kebab-case
#   - target_branch (required): Target branch for PR
#   - args (optional): JSON with component/healthcheck flags
#   - execution_id, description, author, with_examples (optional)
#
# @process-flow Checkout → Setup Python → Parse/Validate Inputs
#
# ═══════════════════════════════════════════════════════════════════════════════

name: Generate NestJS Service Backstage
run-name: '[${{ inputs.execution_id || github.run_id }}] Validating ${{ inputs.project_name || github.event.repository.name }}'

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Repository name (e.g., my-service). Must be kebab-case starting with a lowercase letter.'
        required: true
        type: string
      execution_id:
        description: 'Optional execution ID for tracking (used in run-name)'
        required: false
        type: string
      args:
        description: 'Combined JSON object with component and healthcheck flags (e.g., {"kafka_enabled": true, "kafka_health": true, "redis_enabled": true, "service_type": "graphql"})'
        required: false
        type: string
        default: '{}'
      target_branch:
        description: 'Target branch for PR'
        required: true
        type: string
      description:
        description: 'Optional service description'
        required: false
        type: string
      author:
        description: 'Optional service author/team name'
        required: false
        type: string
      with_examples:
        description: 'Enable example modules for selected features (default: false)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

# Prevent concurrent validation for the same project
concurrency:
  group: generator-${{ inputs.project_name || github.event.repository.name }}
  cancel-in-progress: false

env:
  GENERATOR_NAME: 'core-nest-service'
  TARGET_ORG: 'yopenfoundation'
  JSON_ARGS: ${{ inputs.args }}

jobs:
  validate_inputs:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      project_name: ${{ steps.inputs.outputs.project_name }}
      project_type: ${{ steps.inputs.outputs.project_type }}
      target_repo: ${{ steps.inputs.outputs.target_repo }}
      target_branch: ${{ steps.inputs.outputs.target_branch }}
      pr_branch: ${{ steps.inputs.outputs.pr_branch }}
      components: ${{ steps.inputs.outputs.components }}
      healthcheck_components: ${{ steps.inputs.outputs.healthcheck_components }}
      description: ${{ steps.inputs.outputs.description }}
      author: ${{ steps.inputs.outputs.author }}
      with_examples: ${{ steps.inputs.outputs.with_examples }}

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Parse and validate inputs
        id: inputs
        run: |
          python3 .github/scripts/nestjs-service-generator/validator.py \
            --project-name "${{ inputs.project_name }}" \
            --execution-id "${{ inputs.execution_id }}" \
            --args "$JSON_ARGS" \
            --target-branch "${{ inputs.target_branch }}" \
            --description "${{ inputs.description }}" \
            --author "${{ inputs.author }}" \
            ${{ inputs.with_examples && '--with-examples' || '' }} \
            --target-org "${{ env.TARGET_ORG }}" \
            --generator-name "${{ env.GENERATOR_NAME }}" \
            --output-format github > /tmp/validator_output.txt

          # Extract outputs from the script output (key=value format)
          grep "^[a-z_]*=" /tmp/validator_output.txt | while IFS='=' read -r key value; do
            echo "${key}=${value}" >> "$GITHUB_OUTPUT"
          done

          # Display summary
          grep -A 100 "^### Configuration" /tmp/validator_output.txt >> "$GITHUB_STEP_SUMMARY" || true
